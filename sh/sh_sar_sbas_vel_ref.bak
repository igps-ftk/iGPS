#!/bin/sh

# Name:
#   sh_sar_sbas_vel_ref
#   

# Purpose:
#   

# Example:
#   

# Modifications:
#   

# Algorigthm:
#   

# Dependency:
#   

PROG=sh_sar_sbas_vel_ref

usage(){
  echo "[$PROG]INFO: $PROG -r|-roi|-ref ROI_KML_FILE"
  echo "[$PROG]INFO:     default: ref.kml (plygon)]"
  echo "[$PROG]INFO:   [-f|-file|-file_grid  VEL_LL_GRID_FILE]"
  echo "[$PROG]INFO:     default: vel_mask_ll.grd]"

}

gmt makecpt -Cjet -T-10/10/.1 -Z -I > vel.cpt

\rm _tmp1* _trend.grd _ref_mask.psxy _ref_mask.grd

roi_file=ref.kml

file_grd=vel_mask_ll
#file_grd=vel_ll


while [ "$1" != "" ]; do
  case $1 in
    -f|-file|-file_grd)
      file_grd=$2
      ;;
    -r|-roi|-ref)
      roi_file=$2
      ;;
    *)
      echo "[]ERROR: wrong option ($1)!!"
      exit 1
      ;;
  esac
  shift 2
done


ofile_grd=${file_grd}_ref

#file_mask=_ref_mask.grd


I=`gmt grdinfo -I ${file_grd}.grd`
echo I $I

echo "[$PROG]INFO: create the trend mask from KML polygon file"
gmt kml2gmt $roi_file > _ref_mask.psxy 
#R=`gmt gmtinfo $I _ref_mask.psxy`
#R=-R${xmin}/${xmax}/${ymin}/${ymax}
R=`gmt grdinfo $I ${file_grd}.grd`
echo R $R
gmt grdmask _ref_mask.psxy -R${file_grd}.grd $I -N0/1/1 -G_ref_mask1.grd
#convert zero to NaN
gmt grdmath _ref_mask1.grd 0 NAN = _ref_mask.grd
#the inverse ( gmt grdmath grid.grd 0 AND = NaNtoZero.grd)??
gmt makecpt -Cjet -I -Z -T0/1/1  > mask.cpt
#grd2kml.csh _ref_mask mask.cpt
sh_grd2kml  _ref_mask mask.cpt
 
gmt grdinfo -C ${file_grd}.grd
gmt grdinfo -C _ref_mask.grd
#exit
 
  
  
 
  
    
echo "gmt grdmath ${file_grd}.grd _ref_mask.grd MUL = _tmp1.grd"
echo "gmt grdmath ${file_grd}.grd _ref_mask.grd MUL = _tmp1.grd" | sh
#gmt grdimage _tmp1.grd -JX6.5i -Bxaf+lRange -Byaf+lAzimuth -BWSen -Cvel.cpt -X1.3i -Y3i -P -K > _tmp1.ps
#gmt psscale -R_tmp1.grd -J -DJTC+w5i/0.2i+h+e -Cvel.cpt -Bxaf+l"Unwrapped phase" -By+lrad -O >> _tmp1.ps
#gmt psconvert -A -Tj -P -Z _tmp1.ps

#grd2kml.csh _tmp1 vel.cpt
sh_grd2kml _tmp1 vel.cpt
echo "gmt grdtrend -N3 _tmp1.grd -T_trend.grd"
echo "gmt grdtrend -N3 _tmp1.grd -T_trend.grd" | sh
#  
#gmt grdimage _trend.grd -JX6.5i -Bxaf+lRange -Byaf+lAzimuth -BWSen -C../unwrap.cpt -X1.3i -Y3i -P -K > _trend.ps
#gmt psscale -R_trend.grd -J -DJTC+w5i/0.2i+h+e -C../unwrap.cpt -Bxaf+l"Unwrapped phase" -By+lrad -O >> _trend.ps
#gmt psconvert -A -Tj -P -Z _trend.ps

#gmt grdinfo _trend.grd
#grd2kml.csh _trend vel.cpt    
sh_grd2kml _trend vel.cpt
echo "gmt grdmath ${file_grd}.grd _trend.grd SUB = ${ofile_grd}1.grd"
echo "gmt grdmath ${file_grd}.grd _trend.grd SUB = ${ofile_grd}1.grd" | sh
#grd2kml.csh ${ofile_grd} vel.cpt

#remove the mean
zmean=`gmt grdindo -C -L2 ${ofile_grd}1.grd | awk '{print $12}'`
echo zmean $zmean

ehco "gmt gmtmath ${ofile_grd}1.grd $zmean SUB = ${ofile_grd}.grd"
echo "gmt gmtmath ${ofile_grd}1.grd $zmean SUB = ${ofile_grd}.grd" | sh

sh_grd2kml ${ofile_grd} vel.cpt
#exit

gmt grdsample ${ofile_grd}.grd -I.009 -G${file_grd}3_ref.grd
gmt grd2xyz -s ${file_grd}3_ref.grd > ${file_grd}3_ref.xyz

if [ -s rms_mask_ll3.xyz ]; then
  paste ${file_grd}3_ref.xyz rms_mask_ll3.xyz | awk '{print $1,$2,$3,$6}' > ${file_grd}3_ref.xyze
elif [ -s vel_mask_ll3.xyze ]; then
  paste ${file_grd}3_ref.xyz vel_mask_ll3.xyze | awk '{print $1,$2,$3,$7}' > ${file_grd}3_ref.xyze
else
  echo "[$PROG]WARNING:no velocity uncertainty information!"
fi

echo "[$PROG]INFO:normal end."