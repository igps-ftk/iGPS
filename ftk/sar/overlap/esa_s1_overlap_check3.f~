CTITLE
      PROGRAM esa_s1_overlap_check3

      IMPLICIT NONE
C      INCLUDE '../../inc/cgps.h'

c     --PURPOSE--

c     --ALGORITHM--


c

c     --EXAMPLE--

c     --MODIFICATIONS--
c     + On Tue Oct 27 10:00:34 CST 2015 by tianyf
c     .
c
c

c     >>VAR_DEC
c     --INPUT--
c     --Command-line Parameters--

c     1 path : holding S1 *.manifest.safe files
      character*1023 path
c     2 target: the S1 scene to match
      character*1023 target
c     3 opath : output directory
      character*1023 opath
c     4 perc_min (optional) : minimum percentage of overlapping
c     default to be 0.8 (i.e., 80% overlapping between two polygons)
      real*8 perc_min

c     --OUTPUT--
c     output files in OPATH
      character*1023 ofile,ofile_kml,ofile_psxy

c     --EXTERNAL--
      integer*4 iargc,nblen
      character*1 path_sep
      real*8 polygon_overlap

c     --Local Parameters--

c     maximum number of files
      integer*4 NMax
      parameter(NMAX=100000)

c     for searching input files
      character*1023 files(NMAX),ptn,file
      integer*4 nf

c     for reading manifest.safe file
      character*1023 orbtype,orbtype_target
      integer*4 track,track_target,tracks(NMAX)
      real*8 xys(2,4),xys_all(2,4,NMAX),xys_target(2,4)

c     for calculating overlapping percentage
      real*8 percs(NMAX),perc,xstep,ystep

      character*1023 tmpstr,tmpstrs(10),tfname,efname,tpath,epath
      character*1023 tfile,efile,tmpstr1,tmpstr2,tmpstr3,tmpstr4
      character*3 satyp_tif,satyp_eof
      integer*4 npart
      integer*4 year,mon,day,hh,mm,ss,doyr,date(5)
      real*8 dyra1,dyra2,dyrb1,dyrb2,jd,sec,jd1a,jd1b,jd2a,jd2b
      integer*4 i,j,di,nsiteday,sind
      integer*4 fid,ioerr


c     <<VAR_DEC
      if (iargc().lt.3) then
         write(*,'(3a)') 'Usage: esa_s1_manifest_overlap path target',
     +        'opath [perc_min]'
         stop
      endif
      
      perc_min=.8d0
      xstep=.1d0
      ystep=.1d0

c      write(*,'(a)') '[i]Starting ...________________'
      call getarg(1,tmpstr)
      path=tmpstr(1:nblen(tmpstr))
      write(*,'(3a)') '[]path:',path(1:nblen(path))
      call getarg(2,tmpstr)
      target=tmpstr(1:nblen(tmpstr))
      write(*,'(3a)') '[]target:',target(1:nblen(target))
      call getarg(3,tmpstr)
      opath=tmpstr(1:nblen(tmpstr))
      write(*,'(3a)') '[]opath:',opath(1:nblen(opath))
      if (iargc().ge.4) then
         call getarg(4,tmpstr)
         read (tmpstr,*) perc_min
      endif
      write(*,'(a,f)') '[]perc_min:',perc_min

c     get information in target manifest.safe file
      file=path(1:nblen(path))//'/'//target(1:nblen(target))
      call read_esa_s1_manifest_safe(file,orbtype_target,track_target,
     .     xys)
      write(*,*) 'target orbtype is ', 
     .     orbtype_target(1:nblen(orbtype_target))
      write(*,*) 'target track is ', track_target
      do j=1,4
c     swap the latitude & longitude
         xys_target(1,j)=xys(2,j)
         xys_target(2,j)=xys(1,j)
         write(*,*) 'target xys is ', xys_target(1,j),xys_target(2,j)
      enddo


c     searching *.manifest.safe files in input directory (path)
      ptn='*.manifest.safe'
      write(*,'(3a)') '[]ptn:',ptn(1:nblen(ptn))
      call ffind(path, files, ptn, nf, 1)
      if (nf.le.0) then
         write(*,'(3a)') '[]ERROR: no input metainfo files found in',
     .        path(1:nblen(path)),'!!'
         stop
      endif
c     read *.manifest safe files
      do i=1, nf
         file=files(i)
         write(*,'(3a)') '[]reading ',
     .        file(1:nblen(file)),' ...'
         call read_esa_s1_manifest_safe(file,orbtype,track,xys)
         write(*,*) 'orbtype is ', orbtype(1:nblen(orbtype))
         write(*,*) 'track is ', track
         tracks(i)=track
         do j=1,4
c            write(*,*) 'xys is ', xys(1,j),xys(2,j)
c     swap the longitude and latitude as the above
c     make sure that x is longitude and y is latitude
            xys_all(1,j,i)=xys(2,j)
            xys_all(2,j,i)=xys(1,j)
         enddo
      enddo


c     search matching scenes
 901  do i=1,nf
         file=files(i)
         write(*,'(3a)') '[]testing ',
     .        file(1:nblen(file)),' ...'
c         write(*,*) 'track t vs. i',track_target,tracks(i)
         if (tracks(i).ne.track_target) then
            goto 902
         endif
         do j=1,4
            xys(1,j)=xys_all(1,j,i)
            xys(2,j)=xys_all(2,j,i)
         enddo
         perc=polygon_overlap(xys_target,xys,xstep,ystep)
         percs(i)=perc
         write(*,*) 'perc for ',i,' is ',perc
c         stop

 902     continue
      enddo


      ofile=opath(1:nblen(opath))//path_sep()//'overlapping_'//
     .     target(1:nblen(target))//'.txt'
      write(*,*) '[]out:',ofile(1:nblen(ofile))
      call getlun(fid)
      open(unit=fid,file=ofile,iostat=ioerr)
      if (ioerr.ne.0) then
         write(*,*) '[]ERROR: cannot open output file for writting!!'
         stop
      endif

c     output overlapping scenes
      do i=1, nf
         if (percs(i).lt.perc_min) then
            goto 903
         endif
         file=files(i)
         call getfilename(file,tmpstr)
         write(fid,801) tmpstr(1:nblen(tmpstr)),percs(i)
 801     format(1x,a,1x,f)

 903     continue
      enddo

c     output all scenes as comments (non-blank-first-column lines)
      do i=1, nf
         if (tracks(i).ne.track_target) then
            goto 905
         endif
         file=files(i)
         call getfilename(file,tmpstr)
         write(fid,802) tmpstr(1:nblen(tmpstr)),percs(i)
 802     format("*",a,1x,f)
 905     continue
      enddo

      close(fid)


c     output KML file
      ofile=opath(1:nblen(opath))//path_sep()//'overlapping_'//
     .     target(1:nblen(target))//'.kml'
      write(*,*) '[]out KML:',ofile(1:nblen(ofile))
      open(unit=fid,file=ofile,iostat=ioerr)
      if (ioerr.ne.0) then
         write(*,*) '[]ERROR: cannot open output file for writting!!'
         stop
      endif
      write(fid,'(a)') '<?xml version="1.0" encoding="UTF-8"?>',
     .     '<kml xmlns="http://earth.google.com/kml/2.0">', 
     .     '<Document>'
    
  
      write(fid,'(a)') '    <Style id="yellowLineGreenPoly">',  
     .     '      <LineStyle>       ',  
     .     '        <color>7f00ffff</color>',  
     .     '        <width>2</width>     ',  
     .     '      </LineStyle>     ',  
     .     '      <PolyStyle>       ',  
     .     '        <color>7f00ff00</color>',  
     .     '      </PolyStyle>   ',  
     .     '    </Style>'
  
  
      do i=1, nf
         if (percs(i).lt.perc_min) then
            goto 904
         endif
         file=files(i)
         call getfilename(file,tmpstr)

         write(fid,'(a)') '    <Placemark>'
         write(fid,'(3a)') '      <name>',tmpstr(1:nblen(tmpstr)),
     .        '</name>'
         write(fid,'(3a)') '      <description>',
     .        tmpstr(1:nblen(tmpstr)),'</description>'
         write(fid,'(a)') '      <visibility>1</visibility>'
         write(fid,'(3a)') '      <styleUrl>#yellowLineGreenPoly',
     .        '</styleUrl>'
         write(fid,'(a)') '      <LineString>'
         write(fid,'(a)') '        <tessellate>1</tessellate>'
         write(fid,'(3a)') '        <altitudeMode>clampToGround',
     .        '</altitudeMode>'
         write(fid,'(a)') '        <coordinates>'
         tmpstr=''
         do j=1,4
            write(tmpstr1,803) xys_all(1,j,i)
            write(tmpstr2,803) xys_all(2,j,i)
 803        format(f20.015)
            call strtrim(tmpstr1,tmpstr3)
            call strtrim(tmpstr2,tmpstr4)
            tmpstr=tmpstr(1:nblen(tmpstr))//' '//
     .           tmpstr3(1:nblen(tmpstr3))//','//
     .           tmpstr4(1:nblen(tmpstr4))//',0'
         enddo
    
c     ;link the last vertex to the first one
      j=1
      write(tmpstr1,803) xys_all(1,j,i)
      write(tmpstr2,803) xys_all(2,j,i)
      call strtrim(tmpstr1,tmpstr3)
      call strtrim(tmpstr2,tmpstr4)
      tmpstr=tmpstr(1:nblen(tmpstr))//' '//
     .     tmpstr3(1:nblen(tmpstr3))//','//
     .     tmpstr4(1:nblen(tmpstr4))//',0'

      TMPSTR=TMPSTR(1:nblen(tmpstr))//'</coordinates>'
      write(fid,'(a)') TMPSTR(1:nblen(tmpstr))

      write(fid,'(a)') '      </LineString>'
      write(fid,'(a)') '    </Placemark>'
  
 904  continue
      enddo
  
      write(fid,'(a)')'   </Document>'
      write(fid,'(a)') '</kml>'
  
      close(FID)



      STOP
      END
