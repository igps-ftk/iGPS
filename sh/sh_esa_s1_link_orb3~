#!/bin/sh


if [ "$esa_data" = "" ]; then
    echo "[ERROR]ESA environment variable esa_data must be set first! Stopped."
    exit 1
fi

orbit=aux_poeorb

while [ "$1" != "" ]; do
    case $1 in
        -orbit)
            orbit=$2
            ;;
        *)
            echo "Invalid option $1 !"
            exit 1
            ;;
    esac
    shift 2
done

#path_orb=/g4d/esa.data/aux_poeorb
path_poeorb=${esa_data}/aux_poeorb
path_resorb=${esa_data}/aux_resorb
#path_orb=${esa_data}/${orbit}

#files_orb=`ls ${path_orb}/*.EOF`
#files_poeorb=`find ${path_poeorb} -maxdepth 1 -name "*.EOF"`
#files_resorb=`find ${path_resorb} -maxdepth 1 -name "*.EOF"`

oldyear=
files_tiff=`ls *.tiff`
for file_tiff in $files_tiff; do
    year=`basename $file_tiff | awk -F- '{print substr($5,1,4)}'`
    #echo year is $year
    if [ "$oldyear" != $year ]; then
	oldyear=$year
	files_poeorb=`find ${path_poeorb}/${year} -maxdepth 1 -name "*.EOF"` >& /dev/null
	files_resorb=`find ${path_resorb}/${year} -maxdepth 1 -name "*.EOF"` >& /dev/null
    fi

    tmp=`esa_s1_tiff_EOFs $file_tiff $files_poeorb | head -1`
    file_orb=`echo $tmp | awk '{print $2}'`
    if [ "$file_orb" = "" ]; then
        echo "[]INFO: OOD Precise Orbit NOT found! Trying POD Restituted Orbit [AUX_RESORB]."
        tmp=`esa_s1_tiff_EOFs $file_tiff $files_resorb | head -1`
        file_orb=`echo $tmp | awk '{print $2}'`
        if [ "$file_orb" = "" ]; then
	    echo "[]ERROR:orbit file not found for ${file_tiff}!!"
	    continue
	    #exit 1
	fi
    fi
    ln -s $file_orb
    echo " $file_tiff `basename $file_orb`"
    #exit
done
