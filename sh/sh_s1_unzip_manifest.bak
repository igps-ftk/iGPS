#!/bin/sh

# Name:
#   sh_S1_unzip_manifest
#

# Purpose:
#

# Example:
#

# Modifications:
#

# Algorigthm:
#

# Dependency:
#
PROG=sh_S1_unzip_manifest

#. ${HOME}/.bashrc

if [ "$esa_data" = "" ]; then
    echo "[${PROG}]ERROR: ESA environment variable esa_data must be set first! Stopped."
    exit 1
fi

echo "[${PROG}]INFO: Usage: sh_esa_s1_unzip_manifest [out_path  [input_path] ]"
echo "[${PROG}]INFO:   Default:"
echo "[${PROG}]INFO:     out_path: ${esa_data}/safe/S1"
echo "[${PROG}]INFO:     input_path: ${esa_data}/s1"

#opath=${esa_data}/safe/safe
if [ "$1" == "" ]; then
  opath=${esa_data}/safe/S1
  opath=${esa_data}/metainfo/manifest.safe
else
  oldopath="`pwd`"
  mkdir -p $1
  cd "$1"
  opath="`pwd`"
  cd "$oldopath"
fi

path="${esa_data}/s1"
if [ "$2" != "" ]; then
    oldpath="`pwd`"
    cd "$2"
    path="`pwd`"
    cd "$oldpath"
fi

echo "[${PROG}]INFO:   Currently:"
echo "[${PROG}]INFO:     out_path: ${opath}"
echo "[${PROG}]INFO:     input_path: ${path}"
#exit

mkdir -p $opath
#mkdir -p $opath/all

#files=`ls ${path}/*.zip`
files=`find "$path" -maxdepth 1 -name "S1*.zip"`
np=0
for file in $files; do
    #echo $file
    ofile="${opath}/`basename ${file} | sed -e 's/.zip//g'`.manifest.safe"
    #echo $ofile
    if [ -s "${opath}/`basename $ofile`" ]; then
        #echo "Skip    ${ofile} !"
        continue
    fi
    echo "[${PROG}]INFO: extracting $ofile"
    #continue
    unzip -p "$file" "*manifest.safe" > "$ofile"
    
    if [ ! -s "$ofile" ]; then
      echo "[${PROG}]WARNING: zero size output file! Deleted."
      rm -f "$ofile"
      continue
      #mv $file ${esa_data}/S1/tmp/
    fi
    
    #track=`grep relativeOrbitNumber $ofile | head -1 | awk -F\< '{print $2}' | awk -F\> '{print $2}'`
    #ad=`grep pass $ofile | head -1 | awk -F\< '{print $2}' | awk -F\> '{print substr($2,1,1)}'`
    #echo track $track ad $ad
    #opath_i=${opath}/${ad}${track}
    #echo mkdir -p $opath_i
    #echo mkdir -p $opath_i | sh
    #echo "\mv -f $ofile $opath_i"
    #echo "\mv -f $ofile $opath_i" | sh
    #echo "ln -s ${opath_i}/`basename $ofile` ${opath}/all/"
    #echo "ln -s ${opath_i}/`basename $ofile` ${opath}/all/" | sh
    #exit

    #exit
    np=`expr $np + 1`
done
echo "[${PROG}]INFO: # ${np} manifest.safe files added."

