#!/bin/sh

# Name:
#   sh_esa_s1_check_md5_metalink
#   

# Purpose:
#  Check the S1 file integrity using ASF metalink chcksum files.

# Example:
#   

# Modifications:
#   

# Algorigthm:
#   

# Dependency:
#   

if [ "$esa_data" == "" ]; then
    echo "[]ERROR: environtment variable esa_data NOT set!!"
    exit 1
fi

if [ ! -d $esa_data ]; then
    echo "[]ERROR: directory $esa_data NOT exist!!"
    exit 1
fi

oldpath=`pwd`
tmpfile=.tmp.s1

#find files
#find ${esa_data}/S1 -maxdepth 1 -name "S1*.zip" > $tmpfile

while read line; do
    echo $line

    bname=`basename $line | awk -F. '{print $1}'`
    metafile=${esa_data}/metalink/${bname}.metalink

    if [ ! -e $metafile ]; then
	echo "[]INFO: ASF metafile for $bname NOT exist!"
	continue
    fi

    hashval=`cat $metafile | grep "${bname}.zip" | awk -Fhash '{print $2}' | awk -F'<' '{print $1}' | awk -F'>' '{print $2}'`
    echo $hashval
    if [ "$hashval" == "" ]; then
	echo "{}WARNING: no checksum informaiton found for $bname !!"
	continue
    fi


    md5file="${line}.md5"
    echo $md5file
    if [ ! -e $md5file ]; then
	echo $hashval ${bname}.zip > $md5file
	#echo ""
    fi
    continue
    exit

    okfile="${line}.md5.OK"
    if [ -L $line ]; then
	ls -l $line
	echo "[]INFO: link file skipped ($line2)!"
	continue
    fi
	
    echo okfile $okfile
    if [ -e "$okfile" ]; then
	echo "[]INFO:already done ($okfile). Skipped."
	continue
    fi

    #exit


    exit

    file1="${line}.zip"

    if [ ! -s $file1 ]; then
	echo "[]WARNING:file not found ($file1)!"
	continue
    fi

    #where is the file
    if [ -L $file1 ]; then
	file2=`ls -l $file1 | awk '{print $11}'`
    else
	file2=$file1
    fi

    #loc=`echo $file2 | awk -F\/ '{print $2}'`
    path=`dirname $file2`
    cd $path
    pwd
    echo $line md5sum -c
    tmp=`echo $line | md5sum -c`
    if [ "`echo $tmp | awk '{print $2}'`" == "OK" ]; then
	echo $tmp >> $okfile
    else
	echo '[]WARNING: md5 checksum failed!'
    fi

    cd $oldpath
    exit
done < $tmpfile


