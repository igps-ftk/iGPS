#!/bin/sh

# Name:
#   sh_esa_s1_prep_sbas
#   

# Purpose:
#   Prepare intf.tab and scene.tab files for sbas processing.

# Example:
#   

# Modifications:
#   

# Algorigthm:
#   

# Dependency:
#   
PROG=sh_envisat_prep_sbas

function usage_of_it(){

    echo "Usage: sh_esa_s1_prep_sbas"
    echo "  input:"
    echo "    1) baseline_table.dat"
    echo "    2) intf.in"
    echo "  output:"
    echo "    1) intf.tab"
    echo "    2) scene.tab"
    echo "(c)Copyright 2017 Yunfeng Tian (tianyf@gmail.com)"
}

#default parameters
file_baseline_tab=./baseline_table.dat
file_intf_in=./intf.in
path_intf_all='../ia'
file_unwrap=unwrap_mask.grd
file_corr=corr_cut.grd

while [ "$1" != "" ]; 
do
    case $1 in
	-h)
	     usage_of_it
	    exit 1
	    ;;
	-file_baseline)
	    file_baselin_tab=`pwd`/$2
	    ;;
	-file_intf_in)
	    file_intf_in=`pwd`/$2
	    ;;
	-path_intf_all)
	    path_intf_all=$2
	    ;;
	-file_unwrap)
	    file_unwrap=$2
	    ;;
	-file_corr)
	    file_corr=$2
	    ;;
	*)
	    echo "[$PROG]ERROR: wrong input option ($1)!!"
	    usage_of_it
	    exit 1
	    ;;
    esac
    shift 2
done


if [ ! -e "$file_baseline_tab" ]; then
    echo "[$PROG]ERROR: input file $file_baseline_tab not exist! Stopped!!"
    exit 1
fi
#exit

if [ ! -e "$file_intf_in" ]; then
    echo "[$PROG]ERROR input file $file_intf_in not exist! Stopped!!"
    exit 1
fi


sort -n -k2 $file_baseline_tab > .blentab

\rm -f ./scene.tab1
while read line; do
    #cho $line
    echo $line | awk '{print substr($2,1,7),$3}' >> ./scene.tab1   
done < .blentab

\rm -rf intf.tab1
while read line; do
    id1=`echo $line | awk -F: '{print $1}' | awk -F_ '{print $7}'`
    id2=`echo $line | awk -F: '{print $2}' | awk -F_ '{print $7}'`
    yeardoyr1=`grep "^$id1 " .blentab | awk '{print substr($2,1,7)}'`
    yeardoyr2=`grep "^$id2 " .blentab | awk '{print substr($2,1,7)}'`
    blen1=`grep "^$id1 " .blentab | awk '{print $5}'`
    blen2=`grep "^$id2 " .blentab | awk '{print $5}'`
    echo ${path_intf_all}/${yeardoyr1}_${yeardoyr2}/${file_unwrap}  ${path_intf_all}/${yeardoyr1}_${yeardoyr2}/${file_corr} $yeardoyr1 $yeardoyr2  `echo $blen1 $blen2 | awk '{print $2-$1}'` >> intf.tab1
   # exit
done < $file_intf_in

