#!/bin/sh

# Name:
#   sh_esa_s1_check_md5
#   

# Purpose:
#   

# Example:
#   

# Modifications:
#   

# Algorigthm:
#   

# Dependency:
#   

if [ "$esa_data" == "" ]; then
    echo "[]ERROR: environtment variable esa_data NOT set!!"
    exit 1
fi

if [ ! -d $esa_data ]; then
    echo "[]ERROR: directory $esa_data NOT exist!!"
    exit 1
fi


md5file=${esa_data}/meta4/md5.txt
okfile=${esa_data}/meta4/md5.OK.txt
badfile=${esa_data}/meta4/md5.BAD.txt
oldpath=`pwd`
hostid=`hostname | sed -e 's/[a-z]//g' | sed -e 's/[A-Z]//g'`
echo "hostis=${hostid} for `hostname`"
#exit

#find files
files=`find ${esa_data}/S1 -maxdepth 1 -name "S1*.zip"`
for file in $files; do
    echo $file

    zipname=`basename $file | awk '{print $1}'`
    tmp=`grep $zipname $okfile`
    if [ "$tmp" != "" ]; then
	echo "[]INFO:already done."
	continue
    fi

    hashval=`grep $zipname $md5file | awk '{print $1}'`
    if [ "$hashval" == "" ]; then
	echo "[]WARNING: no checksum information available ($zipname)."
	continue
    fi

    file1=${file}

    #where is the file
    if [ -L $file1 ]; then
	file2=`ls -l $file1 | awk '{print $11}'`
	hostid_file=`echo $file2 | awk -F\/ '{print $2}' | sed -e 's/[a-z]//g' | sed -e 's/[A-Z]//g'`
	echo "hostid_file=${hostid_file} for $file2"
	if [ ${hostid}  -ne ${hostid_file} ]; then
	    continue
	fi
    else
	file2=$file1
    fi

    #loc=`echo $file2 | awk -F\/ '{print $2}'`
    path=`dirname $file2`
    cd $path
    pwd
    echo "echo $hashval $file2 | md5sum -c"
    tmp=`echo $hashval $zipname | md5sum -c`
    if [ "`echo $tmp | awk '{print $2}'`" == "OK" ]; then
	echo $tmp >> $okfile
    else
	echo '[]WARNING: md5 checksum failed!'
	echo $hashval $zipname $file >> $badfile
    fi

    cd $oldpath
    #exit
done


