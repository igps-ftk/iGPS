#!/bin/sh

# Name:
#   sh_esa_s1_get_metalink
#   

# Purpose:
#   Get meta data information for S1 files from ASF

# Example:
#   

# Modifications:
#   

# Algorigthm:
#   

# Dependency:
#   

PROG=sh_esa_s1_get_metalink

if [ "$esa_data" == "" ]; then
  echo "[$PROG]ERROR: environtment variable esa_data NOT set!!"
  exit 1
fi

if [ ! -d $esa_data ]; then
  echo "[$PROG]ERROR: directory $esa_data NOT exist!!"
  exit 1
fi

path=
path=`pwd` #default current path

opath=${esa_data}/metainfo/metalink/ #default esa.data/metalink


while [ "$1" != "" ]; do
    case $1 in 
	-path)
	    path=$2
	    ;;
        -opath)
            opath=$2
            ;;
	*)
	    echo "[$PROG]ERROR: invalid option $1!!"
	    exit 1
	    ;;
    esac
    shift 2
done

#get files list
if [ "$path" == "" ];then
    find ${esa_data}/safe/all/ -maxdepth 1 -name "S1*.manifest.safe" > .s1
    find ${esa_data}/S1/ -maxdepth 1 -name "S1*.zip" >> .s1
    find ${esa_data}/S1.2/ -maxdepth 1 -name "S1*.zip" >> .s1
else
    find $path -maxdepth 1 -name "S1*.zip" > .s1
fi

while read line; do
  fname=`basename $line | awk -F. '{print $1}'`

  URL="https://api.daac.asf.alaska.edu/services/search/param?granule_list=${fname}"
  echo $URL

  ofile=${opath}/${fname}.metalink
  
  if [ -e $ofile ]; then
    echo "[$PROG]INFO: already exist ($ofile). Skip it."
    continue
  fi

  curl $URL > $ofile
  #exit
done < .s1

\rm -rf .s1
