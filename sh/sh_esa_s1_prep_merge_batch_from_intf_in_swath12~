#!/bin/sh

# Name:
#   sh_esa_s1_prep_merge_batch_from_intf_in
#   

# Purpose:
#   

# Example:
#   

# Modifications:
#   +Created by tyf on Thu Dec 28 16:20:53 CST 2017


# Algorigthm:
#   +Convert intf.in to input filelist for merge_batch.csh
#   
#   Inputs:
#     e.g., to combine three descending swaths, first process each swath separately:
#     ../des_F1/intf_all/YYYYDOY_YYYYDOY/
#     ../des_F2/intf_all/YYYYDOY_YYYYDOY/
#     ../des_F3/intf_all/YYYYDOY_YYYYDOY/
# Dependency:
#     

orbtype=des
path=..
Fn=F1
file_intf_in=intf.in

while [ "$1" != "" ]; do
    case $1 in
	-orbtype)
	    orbtype=$2
	    ;;
	-path)
	    oldpath=`pwd`
	    cd $2
	    path=`pwd`
	    cd $oldpath
	    ;;
	-file_intf_in)
	    file_intf_in=$2
	    ;;
	-Fn)
	    Fn=$2
	    ;;
	*)
	    echo "[]ERROR: wrong input $1"
	    echo "Usage: sh_esa_s1_prep_merge_batch"
	    echo "  inputs:"
	    echo "    1) ../asc_F1/intf_all/ or ../asc_F2/intf_all"
	    echo "    2) *F2*"
	    echo "    3) *F3*"
	    echo "(c)Copyright 2017 by Yunfeng Tian (tianyf@gmail.com)"
	    ;;
	esac
    shift 2
done

if [ ! -e $file_intf_in ]; then
    echo "[]ERROR: $file_intf_in file not exist!! Stopped."
    exit 1
fi

while read line; do
    echo " $line"
    ymd1=`echo $line | awk -F: '{print substr($1,4,8)}'`
    ymd2=`echo $line | awk -F: '{print substr($2,4,8)}'`

    year1=`echo $line | awk -F: '{print substr($1,4,4)}'`
    mon1=`echo $line | awk -F: '{print substr($1,8,2)}'`
    day1=`echo $line | awk -F: '{print substr($1,10,2)}'`
    year2=`echo $line | awk -F: '{print substr($2,4,4)}'`
    mon2=`echo $line | awk -F: '{print substr($2,8,2)}'`
    day2=`echo $line | awk -F: '{print substr($2,10,2)}'`

    doyr1=`doy $year1 $mon1 $day1 12 0 | head -1 | awk '{print $6}'`
    doyr2=`doy $year2 $mon2 $day2 12 0 | head -1 | awk '{print $6}'`

    doyr1a=`echo  $doyr1 | awk '{printf("%03d", $1 - 1)}'`
    doyr2a=`echo  $doyr2 | awk '{printf("%03d", $1 - 1)}'`

    if [ -d ${year1}${doyr1a}_${year2}${doyr2a} ]; then
	echo " []WARNING: day ${year1}${doyr1a}_${year2}${doyr2a} aleady done! Skipped."
	continue
    fi

    file1a=../${orbtype}_F1/intf_all/${year1}${doyr1a}_${year2}${doyr2a}/S1A${ymd1}_ALL_F1.PRM
    file1b=../${orbtype}_F1/intf_all/${year1}${doyr1a}_${year2}${doyr2a}/S1A${ymd2}_ALL_F1.PRM

    file2a=`echo $file1a | sed -e 's/F1/F2/g'`
    file3a=`echo $file1a | sed -e 's/F1/F3/g'`
    echo " $file1a"
    echo " $file2a"
    echo " $file3a"

    if [ ! -e $file1a -o ! -e $file2a -o ! -e $file3a ]; then
    #if [ ! -e $file1a -o ! -e $file1b ]; then
	echo " missing one of those ($file1a $file2a $file3a) !!"
	continue
    fi

    echo "  $year1 $mon1 $day1 $year2 $mon2 $day2 $doyr1 "

    odir=`dirname $file1a`
    line_f1="${odir}/:`basename ${file1a}`:`basename ${file1b}`"
    line_f2=`echo $line_f1 | sed -e 's/F1/F2/g'`
    line_f3=`echo $line_f1 | sed -e 's/F1/F3/g'`
    echo $line_f1,$line_f2,$line_f3

    #exit
done < $file_intf_in
