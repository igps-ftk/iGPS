CTITLE
      PROGRAM esa_s1_manifest_overlap

      IMPLICIT NONE
C      INCLUDE '../../inc/cgps.h'

c     --PURPOSE--

c     --ALGORITHM--


c

c     --EXAMPLE--

c     --MODIFICATIONS--
c     + On Tue Oct 27 10:00:34 CST 2015 by tianyf
c     .
c
c

c     >>VAR_DEC
c     --INPUT--
c     --Command-line Parameters--

c     1 path : holding S1 *.manifest.safe files
      character*1023 path
c     2 target: the S1 scene to match
      character*1023 target
c     3 opath : output directory
      character*1023 opath
c     4 perc_min (optional) : minimum percentage of overlapping
c     default to be 0.8 (i.e., 80% overlapping between two polygons)
      real*8 perc_min

c     --OUTPUT--
c     output files in OPATH

c     --EXTERNAL--
      integer*4 iargc,nblen

c     --Local Parameters--
c     for searching input files
      character*1023 files(100000),ptn
      integer*4 nf

      character*1023 tmpstr,tmpstrs(10),tfname,efname,tpath,epath
      character*1023 tfile,efile
      character*3 satyp_tif,satyp_eof
      integer*4 npart
      integer*4 year,mon,day,hh,mm,ss,doyr,date(5)
      real*8 dyra1,dyra2,dyrb1,dyrb2,jd,sec,jd1a,jd1b,jd2a,jd2b
      integer*4 i,j,di,nsiteday,sind
      integer*4 fid,ioerr


c     <<VAR_DEC
      if (iargc().lt.3) then
         write(*,'(3a)') 'Usage: esa_s1_manifest_overlap path target',
     +        'opath [perc_min]'
         stop
      endif
      
      perc_min=.8

c      write(*,'(a)') '[i]Starting ...________________'
      call getarg(1,tmpstr)
      path=tmpstr(1:nblen(tmpstr))
      write(*,'(3a)') '[]path:',path(1:nblen(path))
      call getarg(2,tmpstr)
      target=tmpstr(1:nblen(tmpstr))
      write(*,'(3a)') '[]target:',target(1:nblen(target))
      call getarg(3,tmpstr)
      opath=tmpstr(1:nblen(tmpstr))
      write(*,'(3a)') '[]opath:',opath(1:nblen(opath))
      if (iargc().ge.4) then
         call getarg(4,tmpstr)
         read (tmpstr,*) perc_min
      endif
      write(*,'(a,f)') '[]perc_min:',perc_min

c      call getfilename(tfname,path)

c     searching *.manifest.safe files in input directory (path)
      ptn='*.manifest.safe'
      call ffind(path, files, ptn, nf, 0)
      if (nf.le.0) then
         write(*,'(3a)') '[]ERROR: no input metainfo files found in',
     .        path(1,nblen(path)),'!!'
         stop
      endif
      do i=0, nf
         file=files(i)
         write(*,'(3a)') '[]reading',
     .        file(1,nblen(file)),' ...'
    
      enddo

      stop

      satyp_tif=tfile(1:3)
c     get time
      call strsplit(tfile,'-',npart,tmpstrs)
c      do i=1,npart
c         tmpstr=tmpstrs(i)
c         write(*,*) i,tmpstr(1:nblen(tmpstr))
c      enddo
c     starting time
      read(tmpstrs(5),600) year,mon,day,hh,mm,ss
c     20141027t235315
 600  format(i4,i2,i2,1x,i2,i2,i2)
      date(1)=year
      date(2)=mon
      date(3)=day
      date(4)=hh
      date(5)=mm
      sec=ss
      call ymdhms_to_jd(date,sec,jd)
      jd1a=jd
c      write(*,*) year,mon,day,hh,mm,ss,jd1a
c     ending time
      read(tmpstrs(6),600) year,mon,day,hh,mm,ss
      date(1)=year
      date(2)=mon
      date(3)=day
      date(4)=hh
      date(5)=mm
      sec=ss
      call ymdhms_to_jd(date,sec,jd)
      jd1b=jd
c      write(*,*) year,mon,day,hh,mm,ss,jd1b
      
      do i=2,iargc()
         call getarg(i,tmpstr)
         efname=tmpstr(1:nblen(tmpstr))
         call getfilename(efname,efile)
c     check satellite: A or B?
         satyp_eof=efile(1:3)
         call lowers(satyp_eof)
c         write(*,'(5a)') 'EOF_file: ',efile(1:nblen(efile))
         if (satyp_eof.ne.satyp_tif) then
c            write(*,*) 'satellite does not match'
            goto 700
         endif
c     
         call strsplit(efile,'_',npart,tmpstrs)
c$$$         do j=1,npart
c$$$            tmpstr=tmpstrs(j)
c$$$            write(*,*) j,tmpstr(1:nblen(tmpstr))
c$$$         enddo

c     start time
         read(tmpstrs(7),601) year,mon,day,hh,mm,ss
c     V20150106T225944
 601     format(1x,i4,i2,i2,1x,i2,i2,i2)
         date(1)=year
         date(2)=mon
         date(3)=day
         date(4)=hh
         date(5)=mm
         sec=ss
         call ymdhms_to_jd(date,sec,jd)
         jd2a=jd
c         write(*,*) year,mon,day,hh,mm,ss,jd2a
         if (jd2a>jd1b) then
c            write(*,*) 'time out of range 1'
            goto 700
         endif
c     ending time
         read(tmpstrs(8),600) year,mon,day,hh,mm,ss
         date(1)=year
         date(2)=mon
         date(3)=day
         date(4)=hh
         date(5)=mm
         sec=ss
         call ymdhms_to_jd(date,sec,jd)
         jd2b=jd
c         write(*,*) year,mon,day,hh,mm,ss,jd2b
         if (jd2b<jd1a) then
c            write(*,*) 'time out of range 2'
            goto 700
         endif

         write(*,'(1x,a,1x,a)') tfname(1:nblen(tfname)),
     +        efname(1:nblen(efname))

 700  continue
      enddo

c      stop
c      nproc=nmaxproc-nstable



      STOP
      END
