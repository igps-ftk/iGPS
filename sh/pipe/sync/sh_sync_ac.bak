#!/bin/sh

PROG=sh_sync_ac


this_host=`hostname`
echo "[$PROG]INFO: this host is $this_host"
node_type=`echo $this_host | awk '{print substr($1,1,5)}'`
echo "[$PROG]INFO: node type is $node_type"
if [ "$this_host" != "gpsac4" -a "$this_host" != "gpsac8" ]; then
  echo "[$PROG]ERROR: only run in gpsac4/8 servers!!"
  exit 1
fi

opt_del='--delete'
#opt_del=

if [ ! -s ../ids.$this_host ]; then
  echo "[]ERROR:../ids.$this_host not exist!!"
  exit 1
fi

ids=`cat ../ids`
ids=`grep '^ ' ../ids.$this_host`
#ids='2 3 4 5 6 7 8 9 10 11'
#ids=' 4 5 6 7 9 10 12 13 14 15 16 18 19' #17
#ids=10
#ids='3'
##ids=13
#ids='4 6'
#ids=18


for id in $ids; do

  if [ "$this_host" == "gpsac4" ]; then
  
    echo id is $id

    echo rsync -avP  /home/tianyf/iGPS/sh/pipe/home.tianyf/$this_host/.bashrc gpsac${id}:/home/tianyf/
    echo rsync -avP  /home/tianyf/iGPS/sh/pipe/home.tianyf/$this_host/.bashrc gpsac${id}:/home/tianyf/ | sh

    echo rsync -avP  /home/tianyf/iGPS/sh/pipe/home.tianyf/$this_host/.cshrc gpsac${id}:/home/tianyf/
    echo rsync -avP  /home/tianyf/iGPS/sh/pipe/home.tianyf/$this_host/.cshrc gpsac${id}:/home/tianyf/ | sh

    echo rsync -avP  /home/tianyf/iGPS/sh/pipe/home.tianyf/$this_host/authorized_keys gpsac${id}:/home/tianyf/.ssh/
    echo rsync -avP  /home/tianyf/iGPS/sh/pipe/home.tianyf/$this_host/authorized_keys gpsac${id}:/home/tianyf/.ssh/ | sh
  
    if [ $id -eq 4 ]; then
      continue
    fi

    echo rsync -avP  /home/tianyf/sh_mount_ac gpsac${id}:/home/tianyf/
    echo rsync -avP  /home/tianyf/sh_mount_ac gpsac${id}:/home/tianyf/ | sh
    #continue


    case $id in
      10)
        echo rsync -avP ${opt_del}  /home/tianyf/iGPS gpsac${id}:/home/tianyf/
        echo rsync -avP ${opt_del} --include="*/" --include="Makefile.generic" --include="*.f" --include="cron*" --include="sh*" --exclude="*"  /home/tianyf/iGPS gpsac${id}:/home/tianyf/ | sh
        echo rsync -avP ${opt_del}  /home/tianyf/iGPS/sh gpsac${id}:/home/tianyf/iGPS | sh
        echo rsync -avP ${opt_del} /home/tianyf/iGPS.addon gpsac${id}:/home/tianyf/
        echo rsync -avP ${opt_del} --include="*/" --include="Makefile.generic" --include="*.f" --include="cron*" --include="sh*" --exclude="*" /home/tianyf/iGPS.addon gpsac${id}:/home/tianyf/ | sh
        echo rsync -avP ${opt_del}  /home/tianyf/iGPS.addon/sh gpsac${id}:/home/tianyf/iGPS.addon/ | sh
        ;;
      *)
        echo rsync -avP ${opt_del}  /home/tianyf/iGPS gpsac${id}:/home/tianyf/
        echo rsync -avP ${opt_del}  /home/tianyf/iGPS gpsac${id}:/home/tianyf/ | sh
        echo rsync -avP ${opt_del} /home/tianyf/iGPS.addon gpsac${id}:/home/tianyf/
        echo rsync -avP ${opt_del} /home/tianyf/iGPS.addon gpsac${id}:/home/tianyf/ | sh
        ;;
    esac
    
  fi



   echo "synchronizing /usr/local/..."
  if [ "$this_host" == "gpsac6" ]; then
    echo id is $id
    if [ $id -eq 6 -o $id -eq -13 -o $id -eq -10 -o $id -eq 14 ]; then
      continue
    fi
  
    #echo rsync -avP  /usr/local/dcw-gmt-1.1.4 gpsac${id}:/usr/local/
    #echo rsync -avP  /usr/local/dcw-gmt-1.1.4 gpsac${id}:/usr/local/ | sh
    
    #echo rsync -avP  /usr/local/gshhg-gmt-2.3.7 gpsac${id}:/usr/local/
    #echo rsync -avP  /usr/local/gshhg-gmt-2.3.7 gpsac${id}:/usr/local/ | sh
        
    
    #echo rsync -avP  /usr/local/slurm gpsac${id}:/usr/local/
    #echo rsync -avP  /usr/local/slurm gpsac${id}:/usr/local/ | sh
    
    #echo rsync -avP  /etc/slurm gpsac${id}:/etc/
    #echo rsync -avP  /etc/slurm gpsac${id}:/etc/ | sh
    
    #echo rsync -avP  /usr/local/gamit-v10.7 gpsac${id}:/usr/local/
    #echo rsync -avP  /usr/local/gamit-v10.7 gpsac${id}:/usr/local/ | sh

    #echo rsync -avP  /usr/local/GMT-6.0.0i gpsac${id}:/usr/local/
    #echo rsync -avP  /usr/local/GMT-6.0.0i gpsac${id}:/usr/local/ | sh
    
    echo rsync -avP ${opt_del}  /usr/local/gmt5sar20200529 gpsac${id}:/usr/local/
    echo rsync -avP --include "*.csh" --include "*.c" --include "*.h" --include '*/' --exclude '*' /usr/local/gmt5sar20200529 gpsac${id}:/usr/local/ | sh
    cmdstr='cd /usr/local/gmt5sar20200529 && make install'
    ssh gpsac${id} $cmdstr

  fi
  
  #exit
done


#update to node1
if [ "$this_host" == "gpsac6" ]; then
    echo rsync -avP ${opt_del}  /usr/local/gmt5sar20200529 node1:/usr/local/
    echo rsync -avP --include "*.csh" --include "*.c" --include "*.h" --include '*/' --exclude '*' /usr/local/gmt5sar20200529 node1:/usr/local/ | sh



fi
